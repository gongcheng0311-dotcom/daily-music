# æ¯æ—¥éŸ³ä¹æ¨è

åŸºäº Next.js (App Router) + TypeScript + Supabase çš„éŸ³ä¹æ¨èç½‘ç«™ã€‚

## åŠŸèƒ½

- ğŸ“… æ¯æ—¥æ­Œæ›²æ¨èå±•ç¤º
- ğŸµ æ”¯æŒ QQ éŸ³ä¹å’Œ Bilibili åµŒå…¥
- â­ ç”¨æˆ·è¯„åˆ†ï¼ˆ1-10 åˆ†ï¼ŒUpsert æ”¹åˆ†ï¼‰
- ğŸ’¬ è¯„è®ºåŠŸèƒ½
- ğŸ” Email Magic Link ç™»å½•

## ç›®å½•ç»“æ„

```
â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”œâ”€â”€ (routes)/          # é¡µé¢è·¯ç”±
â”‚   â”œâ”€â”€ auth/callback/     # ç™»å½•å›è°ƒå¤„ç†
â”‚   â”œâ”€â”€ songs/[date]/      # æ­Œæ›²è¯¦æƒ…é¡µ
â”‚   â”œâ”€â”€ globals.css        # å…¨å±€æ ·å¼
â”‚   â”œâ”€â”€ layout.tsx         # æ ¹å¸ƒå±€
â”‚   â”œâ”€â”€ login/page.tsx     # ç™»å½•é¡µ
â”‚   â””â”€â”€ page.tsx           # é¦–é¡µ
â”œâ”€â”€ components/            # React ç»„ä»¶
â”‚   â”œâ”€â”€ CommentComponent.tsx
â”‚   â”œâ”€â”€ MusicPlayer.tsx
â”‚   â””â”€â”€ RatingComponent.tsx
â”œâ”€â”€ lib/                   # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ supabase/         # Supabase å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ client.ts     # æµè§ˆå™¨å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ middleware.ts # ä¸­é—´ä»¶
â”‚   â”‚   â””â”€â”€ server.ts     # æœåŠ¡ç«¯å®¢æˆ·ç«¯
â”‚   â””â”€â”€ utils.ts          # é€šç”¨å·¥å…·
â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ schema.sql        # æ•°æ®åº“ Schema
â”œâ”€â”€ types/
â”‚   â””â”€â”€ database.ts       # TypeScript ç±»å‹
â””â”€â”€ .env.example          # ç¯å¢ƒå˜é‡ç¤ºä¾‹
```

## å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»º Supabase é¡¹ç›®

1. è®¿é—® [Supabase](https://supabase.com/) æ³¨å†Œ/ç™»å½•
2. åˆ›å»ºæ–°é¡¹ç›®
3. è¿›å…¥ SQL Editor â†’ New query
4. å¤åˆ¶ `supabase/schema.sql` ä¸­çš„å…¨éƒ¨å†…å®¹ç²˜è´´æ‰§è¡Œ

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼š

```bash
cp .env.example .env.local
```

ç¼–è¾‘ `.env.local`ï¼Œå¡«å…¥ä½ çš„ Supabase ä¿¡æ¯ï¼š

```
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
```

è·å–ä½ç½®ï¼šSupabase Dashboard â†’ Project Settings â†’ API

### 3. å®‰è£…ä¾èµ–

```bash
npm install
```

### 4. æœ¬åœ°å¼€å‘

```bash
npm run dev
```

è®¿é—® http://localhost:3000

### 5. é…ç½® Email Magic Link

åœ¨ Supabase Dashboard â†’ Authentication â†’ Providers â†’ Email ä¸­ï¼š

1. å¯ç”¨ **Confirm email**ï¼ˆå»ºè®®å¼€å¯ï¼Œé˜²æ­¢åƒåœ¾æ³¨å†Œï¼‰
2. å¯é€‰ï¼šè‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿

### 6. è®¾ç½®ç®¡ç†å‘˜

1. å…ˆç”¨æ™®é€šç”¨æˆ·æ–¹å¼ç™»å½•ä¸€æ¬¡ï¼ˆåˆ›å»º profile è®°å½•ï¼‰
2. åœ¨ Supabase Dashboard â†’ Table Editor â†’ profiles è¡¨ä¸­
3. æ‰¾åˆ°ä½ çš„ç”¨æˆ·ï¼Œå°† `is_admin` è®¾ä¸º `true`

### 7. æ·»åŠ æµ‹è¯•æ•°æ®

åœ¨ SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- æ·»åŠ ä¸€é¦–æµ‹è¯•æ­Œæ›²
INSERT INTO songs (date, title, artist, album, description, lyrics, qq_music_url, qq_music_id, bilibili_bvid)
VALUES (
  '2024-01-15',
  'æ™´å¤©',
  'å‘¨æ°ä¼¦',
  'å¶æƒ ç¾',
  'è¿™æ˜¯ä¸€é¦–ç»å…¸çš„åè¯­æµè¡Œæ­Œæ›²...',
  'æ•…äº‹çš„å°é»„èŠ±\nä»å‡ºç”Ÿé‚£å¹´å°±é£˜ç€\nç«¥å¹´çš„è¡ç§‹åƒ\néšè®°å¿†ä¸€ç›´æ™ƒåˆ°ç°åœ¨',
  'https://y.qq.com/n/ryqq/songDetail/004Z8Ihr0JIu5s',
  '004Z8Ihr0JIu5s',
  'BV1xxxxxx'
);
```

## åŠŸèƒ½éªŒè¯æ¸…å•

### é¦–é¡µ `/`
- [ ] æ˜¾ç¤ºä»Šæ—¥/æœ€æ–°æ¨èçš„æ­Œæ›²
- [ ] å°é¢ã€æ ‡é¢˜ã€è‰ºæœ¯å®¶æ­£ç¡®æ˜¾ç¤º
- [ ] ç‚¹å‡»"æŸ¥çœ‹è¯¦æƒ…"è¿›å…¥è¯¦æƒ…é¡µ
- [ ] å†å²æ—¥æœŸåˆ—è¡¨å±•ç¤º

### æ­Œæ›²è¯¦æƒ…é¡µ `/songs/YYYY-MM-DD`
- [ ] æ­Œæ›²ä¿¡æ¯å®Œæ•´å±•ç¤º
- [ ] QQ éŸ³ä¹è·³è½¬æŒ‰é’®å¯ç”¨
- [ ] Bilibili è§†é¢‘å¯åµŒå…¥æ’­æ”¾
- [ ] å¹³å‡åˆ†/è¯„åˆ†äººæ•°æ˜¾ç¤º

### ç™»å½• `/login`
- [ ] è¾“å…¥é‚®ç®±èƒ½å‘é€ Magic Link
- [ ] æ”¶åˆ°é‚®ä»¶å¹¶ç‚¹å‡»é“¾æ¥åèƒ½ç™»å½•
- [ ] ç™»å½•åè·³è½¬åˆ°é¦–é¡µ

### è¯„åˆ†åŠŸèƒ½
- [ ] æœªç™»å½•æ—¶æç¤ºç™»å½•
- [ ] ç™»å½•åèƒ½é€‰æ‹© 1-10 åˆ†
- [ ] é‡å¤è¯„åˆ†ä¸ºä¿®æ”¹ï¼ˆUpsertï¼‰
- [ ] åˆ é™¤è¯„åˆ†åŠŸèƒ½æ­£å¸¸

### è¯„è®ºåŠŸèƒ½
- [ ] æœªç™»å½•æ—¶æç¤ºç™»å½•
- [ ] ç™»å½•åèƒ½å‘è¡¨è¯„è®º
- [ ] è¯„è®ºæ—¶é—´æˆ³æ­£ç¡®æ˜¾ç¤º
- [ ] èƒ½åˆ é™¤è‡ªå·±çš„è¯„è®º

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Next.js 14 (App Router)
- **è¯­è¨€**: TypeScript
- **æ ·å¼**: CSS Modules + å†…è”æ ·å¼
- **æ•°æ®åº“**: Supabase (PostgreSQL)
- **è®¤è¯**: Supabase Auth (Email Magic Link)
- **éƒ¨ç½²**: Vercel (æ¨è)

## æ³¨æ„äº‹é¡¹

### QQ éŸ³ä¹åµŒå…¥é™åˆ¶
QQ éŸ³ä¹ç½‘é¡µç‰ˆå— X-Frame-Options é™åˆ¶ï¼Œæ— æ³•ç›´æ¥åµŒå…¥ iframeã€‚ä»£ç å·²åšé™çº§å¤„ç†ï¼Œæ˜¾ç¤ºå¤–éƒ¨é“¾æ¥æŒ‰é’®ã€‚

### RLS ç­–ç•¥
æ‰€æœ‰è¡¨å·²å¯ç”¨ Row Level Securityï¼š
- `songs`: å…¬å¼€è¯»å–ï¼Œä»… admin å¯å†™å…¥
- `ratings`: å…¬å¼€è¯»å–ï¼Œç”¨æˆ·åªèƒ½æ“ä½œè‡ªå·±çš„
- `comments`: å…¬å¼€è¯»å–ï¼Œç”¨æˆ·åªèƒ½æ’å…¥/åˆ é™¤è‡ªå·±çš„
- `profiles`: å…¬å¼€è¯»å–ï¼Œç”¨æˆ·åªèƒ½æ›´æ–°è‡ªå·±çš„

### éƒ¨ç½²åˆ° Vercel

1. æ¨é€ä»£ç åˆ° GitHub
2. åœ¨ Vercel å¯¼å…¥é¡¹ç›®
3. é…ç½®ç¯å¢ƒå˜é‡ï¼ˆåŒä¸Šï¼‰
4. éƒ¨ç½²

## è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹ç®¡ç†å‘˜
åœ¨ SQL Editor ä¸­æ‰§è¡Œï¼š
```sql
-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
SELECT * FROM profiles;

-- è®¾ç½®æŸç”¨æˆ·ä¸ºç®¡ç†å‘˜
UPDATE profiles SET is_admin = TRUE WHERE id = 'ç”¨æˆ·UID';

-- å–æ¶ˆç®¡ç†å‘˜
UPDATE profiles SET is_admin = FALSE WHERE id = 'ç”¨æˆ·UID';
```

### ä¿®æ”¹è¯„åˆ†èŒƒå›´
é»˜è®¤ 1-10 åˆ†ï¼Œå¦‚éœ€ä¿®æ”¹éœ€åŒæ—¶æ›´æ–°ï¼š
1. `ratings` è¡¨çš„ CHECK çº¦æŸ
2. å‰ç«¯ `RatingComponent` çš„æŒ‰é’®æ•°é‡

## è®¸å¯è¯

MIT
